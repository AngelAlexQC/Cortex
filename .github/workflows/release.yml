name: Release

on:
  push:
    branches:
      - main
    paths:
      - 'packages/**'
      - 'package.json'
  workflow_dispatch:

permissions:
  contents: write
  id-token: write # Required for NPM provenance

jobs:
  release:
    name: Build & Publish
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      # Check if version has changed
      - name: Check Version
        id: check_version
        shell: bash
        run: |
          # Read version from vscode-extension package.json (Product Version)
          PACKAGE_VERSION=$(jq -r .version packages/vscode-extension/package.json)
          echo "Current version in package.json: $PACKAGE_VERSION"

          # Check if git tag exists
          if git rev-parse "v$PACKAGE_VERSION" >/dev/null 2>&1; then
            echo "Tag v$PACKAGE_VERSION already exists. Skipping release."
            echo "RELEASE=false" >> $GITHUB_ENV
          else
            echo "Tag v$PACKAGE_VERSION does not exist. Proceeding with release."
            echo "RELEASE=true" >> $GITHUB_ENV
            echo "VERSION=$PACKAGE_VERSION" >> $GITHUB_ENV
          fi

      - name: Setup Node.js
        if: env.RELEASE == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        if: env.RELEASE == 'true'
        run: bun install --frozen-lockfile

      - name: Build all packages
        if: env.RELEASE == 'true'
        run: bun run build

      - name: Run Tests
        if: env.RELEASE == 'true'
        run: bun test

      # Publish NPM Packages in dependency order
      # Using npm publish --provenance for security

      - name: Publish @cortex/shared
        if: env.RELEASE == 'true'
        working-directory: packages/shared
        run: npm publish --provenance --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        continue-on-error: true # Continue if version already exists

      - name: Publish @cortex/core
        if: env.RELEASE == 'true'
        working-directory: packages/core
        run: npm publish --provenance --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        continue-on-error: true

      - name: Publish @cortex/cli
        if: env.RELEASE == 'true'
        working-directory: packages/cli
        run: npm publish --provenance --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        continue-on-error: true

      - name: Publish @cortex/mcp-server
        if: env.RELEASE == 'true'
        working-directory: packages/mcp-server
        run: npm publish --provenance --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        continue-on-error: true

      # Package and Publish VS Code Extension with Isolation Strategy
      - name: Package VS Code Extension (Isolated)
        if: env.RELEASE == 'true'
        run: |
          mkdir -p vscode-build
          cp packages/vscode-extension/package.json vscode-build/
          cp packages/vscode-extension/README.md vscode-build/
          cp packages/vscode-extension/CHANGELOG.md vscode-build/
          cp packages/vscode-extension/icon.png vscode-build/
          cp packages/vscode-extension/.vscodeignore vscode-build/
          cp -r packages/vscode-extension/resources vscode-build/

          # Try to copy LICENSE (exact name variation)
          if [ -f packages/vscode-extension/LICENSE.txt ]; then
            cp packages/vscode-extension/LICENSE.txt vscode-build/
          elif [ -f LICENSE ]; then
            cp LICENSE vscode-build/LICENSE.txt
          fi

          # Copy Bundled Dist
          mkdir -p vscode-build/dist
          cp packages/vscode-extension/dist/* vscode-build/dist/

          cd vscode-build

          # Use jq to remove workspace dependencies that are already bundled
          # and disable prepublish script to prevent rebuilding
          jq 'del(.devDependencies["@cortex/shared"])' package.json > tmp.json && mv tmp.json package.json
          jq '.scripts["vscode:prepublish"] = "echo ok"' package.json > tmp.json && mv tmp.json package.json

          # Install PROD dependencies only (sql.js)
          bun install --production

          # Package
          bunx vsce package

          # Move VSIX back to expected location
          cp *.vsix ../packages/vscode-extension/

      - name: Publish VS Code Extension
        if: env.RELEASE == 'true' && env.VSCE_PAT != ''
        working-directory: vscode-build
        run: bunx vsce publish -p ${{ secrets.VSCE_PAT }} --packagePath *.vsix
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}
        continue-on-error: true

      - name: Create GitHub Release
        if: env.RELEASE == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.VERSION }}
          name: Release v${{ env.VERSION }}
          generate_release_notes: true
          files: |
            packages/vscode-extension/*.vsix

      # Auto-tag the version in git if successful
      - name: Push Git Tag
        if: env.RELEASE == 'true'
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git tag v${{ env.VERSION }}
          git push origin v${{ env.VERSION }}
